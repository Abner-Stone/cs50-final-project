{% extends 'layout.html' %}

{% block referrer %}
<meta name="referrer" content="no-referrer-when-downgrade" />
{% endblock %}

{% block main %}
<script src="https://accounts.google.com/gsi/client" async defer></script>
<div id="g_id_onload"
     data-client_id="173184994997-u61e9in6dkrp545hl8eqpkjl3b7ru8bl.apps.googleusercontent.com"
     data-context="signin"
     data-ux_mode="popup"
     data-auto_select="false"
     data-itp_support="true"
     data-callback="handleCredentialResponse">
</div>

<div class="g_id_signin"
     data-type="standard"
     data-shape="rectangular"
     data-theme="filled_blue"
     data-text="continue_with"
     data-size="large"
     data-logo_alignment="left"
     data-callback="handleCredentialResponse">
</div>

<script>
    function sendPayload(responsePayload) {
        login_attempt = 1
        obj1 = JSON.stringify(responsePayload)
        obj2 = JSON.stringify(login_attempt)
        console.log(obj1)
        console.log(obj2)
        $.ajax({
            url:"/",
            type: "POST",
            contentType: "application/json",
            data:
                JSON.stringify(responsePayload)
        });
    }

    function parseJwt (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
       var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
         return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
       }).join(''));
     
       return JSON.parse(jsonPayload);
     };

     function handleCredentialResponse(response) {
       // decodeJwtResponse() is a custom function defined by you
       // to decode the credential response.
       const responsePayload = parseJwt(response.credential);
       responsePayload["login_attempt"] = 1

       sendPayload(responsePayload)
       window.location.href = "/"
    }

  </script>
{% endblock %}